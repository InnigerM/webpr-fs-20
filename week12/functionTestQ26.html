<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Function Tests</title>
</head>
<body>
<pre><script>
    const Scheduler = () => {
        let inProcess = false;
        const tasks = [];

        function process() {
            if (inProcess) {
                return;
            }
            if (tasks.length === 0) {
                return;
            } // guard clause
            inProcess = true;
            const task = tasks.pop();

            new Promise((resolve, reject) => {
                task(resolve);
            }).then (() => {
                inProcess = false;
                process();
            });
        }

        function add(task) {
            tasks.unshift(task);
            process();
        }

        return {
            add: add,
            addOk: task => add(ok => {
                task();
                ok();
            }) // convenience
        }
    };

    // //26.1 // 26.3
    // let state = [0];
    // const scheduler = Scheduler();
    // scheduler.add(ok => {
    //     setTimeout(_ => {
    //         state.push(1);
    //         ok();
    //     }, 100)
    // });
    // scheduler.add(ok => {
    //     state.push(2);
    //     ok();
    // });
    // scheduler.add(ok => {
    //     document.writeln(state);
    //     ok();
    // });

    //26.2
    // let state = 3;
    // const scheduler = Scheduler();
    // scheduler.add(ok => {
    //     setTimeout(_ => {
    //         state = state - 2;
    //         ok();
    //     }, 100)
    // });
    // scheduler.add(ok => {
    //     state = state - 1;
    //     ok();
    // });
    // scheduler.add(ok => {
    //     document.writeln(state);
    //     ok();
    // });

    //26.4
    // let state = [0];
    // const scheduler = Scheduler();
    // scheduler.add(ok => {
    //     setTimeout(_ => {
    //         state.push(1);
    //         ok();
    //     }, 100)
    // });
    // scheduler.add(ok => {
    //     state.push(2);
    //     ok();
    // });
    // document.writeln(state);

    //26.5 // 26.6
    // let state = 3;
    // const scheduler = Scheduler();
    // scheduler.add(ok => {
    //     setTimeout(_ => {
    //         state = state - 2;
    //         ok();
    //     }, 100)
    // });
    // scheduler.add(ok => {
    //     state = state - 1;
    //     ok();
    // });
    // scheduler.add(ok => {
    //     console.log(state);
    //     ok();
    // });
    //
    // console.log('x');

    //26.7
    // let state = [0];
    // const scheduler = Scheduler();
    // scheduler.add(ok => {
    //     setTimeout(_ => {
    //         state.push(1);
    //         ok();
    //     }, 100)
    // });
    // scheduler.add(ok => {
    //     state.push(2);
    //     ok();
    // });
    // document.writeln(state);

    //26.8
    // let state = [0];
    // const scheduler = Scheduler();
    // scheduler.add(ok => {
    //     setTimeout(_ => {
    //         state.push(1);
    //         ok();
    //     }, 100)
    // });
    // scheduler.add(ok => {
    //     state.push(2);
    //     ok();
    // });
    // scheduler.add(ok => {
    //     document.writeln(state);
    //     ok();
    // })

    //26.9
    // let state = 3;
    // const scheduler = Scheduler();
    // scheduler.add(ok => {
    //     setTimeout(_ => {
    //         state = state - 2;
    //         ok();
    //     }, 100)
    // });
    // scheduler.add(ok => {
    //     state = state - 1;
    //     ok();
    // });
    // scheduler.add(ok => {
    //     console.log(state);
    //     ok();
    // })
    // console.log('x');

    //26.10
    // let state = [0];
    // const scheduler = Scheduler();
    // scheduler.add(ok => {
    //     setTimeout(_ => {
    //         state.push(1);
    //         ok();
    //     }, 100)
    // });
    // scheduler.add(ok => {
    //     state.push(2);
    //     ok();
    // });
    // scheduler.add(ok => {
    //     document.writeln(state);
    //     ok();
    // })

    //26.11 // 26.12
    let state = [0];
    const scheduler = Scheduler();
    scheduler.add(ok => {
        setTimeout(_ => {
            state.push(1);
            ok();
        }, 100)
    });
    scheduler.add(ok => {
        state.push(2);
        ok();
    });
    document.writeln(state);
    </script>
    </pre>
</body>
</html>